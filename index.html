<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Puter Claude Chat — claude-sonnet-4-5</title>

  <!-- Puter.js (no API keys, client-side) -->
  <script src="https://js.puter.com/v2/"></script>

  <!-- Highlight.js for code rendering -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/default.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

  <style>
    :root {
      --bg: #0f1724;
      --card: #0b1220;
      --muted: #94a3b8;
      --accent: #7c3aed;
      --glass: rgba(255,255,255,0.03);
    }
    html,body { height:100%; margin:0; font-family:Inter,ui-sans-serif,system-ui,Segoe UI,Roboto,"Helvetica Neue",Arial; background:linear-gradient(180deg,#07102a 0%, #071827 100%); color: #e6eef8; }
    .app { max-width:1100px; margin:28px auto; display:grid; grid-template-columns: 1fr 360px; gap:18px; padding:18px; }
    .card { background:var(--card); border-radius:14px; padding:14px; box-shadow: 0 6px 24px rgba(2,6,23,0.6); }
    header { display:flex; gap:12px; align-items:center; margin-bottom:12px; }
    header h1 { font-size:18px; margin:0; }
    .chat { display:flex; flex-direction:column; height:76vh; }
    .messages { overflow:auto; padding:12px; flex:1; display:flex; flex-direction:column; gap:10px; }
    .msg { max-width:80%; padding:12px; border-radius:10px; word-break:break-word; font-size:14px; }
    .user { align-self:flex-end; background:linear-gradient(90deg,#3b82f6,#06b6d4); color:#021129; }
    .assistant { align-self:flex-start; background:var(--glass); color:var(--muted); border:1px solid rgba(255,255,255,0.03); }
    .meta { font-size:12px; color:var(--muted); margin-bottom:8px; }
    .inputRow { display:flex; gap:8px; margin-top:10px; }
    .inputRow textarea { flex:1; min-height:48px; max-height:160px; border-radius:10px; padding:10px; background:transparent; border:1px solid rgba(255,255,255,0.06); color:inherit; resize:vertical; }
    .btn { background:var(--accent); border:0; color:white; padding:10px 14px; border-radius:10px; cursor:pointer; font-weight:600; }
    .sidebar { display:flex; flex-direction:column; gap:12px; height:76vh; }
    .uploadDrop { border:1px dashed rgba(255,255,255,0.06); padding:12px; border-radius:10px; min-height:120px; display:flex; align-items:center; justify-content:center; text-align:center; color:var(--muted); }
    .filesList { display:flex; flex-direction:column; gap:8px; max-height:220px; overflow:auto; }
    .fileItem { background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.03)); padding:8px; border-radius:8px; font-size:13px; }
    .small { font-size:12px; color:var(--muted); }
    pre.code { background:#0b1220; padding:10px; border-radius:8px; overflow:auto; font-size:13px; color:#dff1ff; }
    footer { margin-top:8px; text-align:right; font-size:12px; color:var(--muted); }
    .hint { font-size:13px; color:var(--muted); }
    /* responsive */
    @media (max-width:980px) { .app { grid-template-columns: 1fr; } .sidebar { order:2; } }
  </style>
</head>
<body>
  <div class="app">
    <div class="card chat">
      <header>
        <img src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='36' height='36'><rect rx='8' width='36' height='36' fill='%237c3aed'/><text x='50%' y='58%' font-size='18' text-anchor='middle' fill='white' font-family='Arial'>C</text></svg>" alt="logo" style="width:36px;height:36px;border-radius:8px"/>
        <div>
          <h1>Puter Claude (claude-sonnet-4-5) — Code helper</h1>
          <div class="small">Upload code files, ask questions, stream responses.</div>
        </div>
      </header>

      <div class="messages" id="messages" aria-live="polite"></div>

      <div class="inputRow">
        <textarea id="messageInput" placeholder="Write a prompt, or describe what you want the assistant to do with uploaded files (e.g. 'Review main.py and suggest performance improvements')"></textarea>
        <button class="btn" id="sendBtn">Send</button>
      </div>
      <div style="display:flex;justify-content:space-between;align-items:center;margin-top:8px">
        <div class="small">Model: <strong>claude-sonnet-4-5</strong></div>
        <div class="small hint">Note: Puter.js runs client-side; no API key needed — usage is billed per Puter’s user-pays model. See docs. </div>
      </div>
    </div>

    <aside class="card sidebar">
      <div>
        <strong>Upload code files</strong>
        <div class="small">Drag & drop or select text files (JS, PY, TXT). Files are read client-side and added to the message sent to Claude.</div>
      </div>

      <label class="uploadDrop" id="dropZone">
        Drop files here or click to select
        <input type="file" id="fileInput" multiple style="display:none" accept=".js,.py,.txt,.json,.md,.ts,.jsx,.tsx"/>
      </label>

      <div>
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <strong>Files to attach</strong>
          <button id="clearFiles" class="btn" style="background:#ef4444;padding:6px 10px;font-size:13px">Clear</button>
        </div>
        <div class="filesList" id="filesList"></div>
      </div>

      <div style="margin-top:auto;">
        <div class="small" style="margin-bottom:8px">When sending, file contents will be prepended with a header like:</div>
        <pre class="small" style="background:transparent;border-radius:6px;border:1px solid rgba(255,255,255,0.03);padding:8px"><code>-- filename: main.py -- (language: python)
&lt;file contents&gt;</code></pre>
        <footer>
          <div class="small">Puter.js script: <code>https://js.puter.com/v2/</code>. Models available include <code>claude-sonnet-4-5</code>. (See docs.)</div>
        </footer>
      </div>
    </aside>
  </div>

  <script>
    // Basic DOM hooks
    const messagesEl = document.getElementById('messages');
    const sendBtn = document.getElementById('sendBtn');
    const input = document.getElementById('messageInput');
    const dropZone = document.getElementById('dropZone');
    const fileInput = document.getElementById('fileInput');
    const filesListEl = document.getElementById('filesList');
    const clearFilesBtn = document.getElementById('clearFiles');

    // Keep files in memory (client-side)
    let uploadedFiles = []; // {name, type, content}

    // Utility: add message
    function addMessage(contentHTML, type='assistant', meta='') {
      const div = document.createElement('div');
      div.className = 'msg ' + (type === 'user' ? 'user' : 'assistant');
      if (meta) {
        const m = document.createElement('div');
        m.className = 'meta';
        m.textContent = meta;
        div.appendChild(m);
      }
      const inner = document.createElement('div');
      inner.innerHTML = contentHTML;
      div.appendChild(inner);
      messagesEl.appendChild(div);
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    // File handling
    function renderFilesList() {
      filesListEl.innerHTML = '';
      uploadedFiles.forEach((f, idx) => {
        const el = document.createElement('div');
        el.className = 'fileItem';
        el.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center">
          <div><strong>${escapeHtml(f.name)}</strong> <span class="small">(${f.size} bytes)</span></div>
          <div style="display:flex;gap:8px">
            <button data-idx="${idx}" class="btn previewBtn" style="background:#06b6d4;padding:6px 8px;font-size:12px">Preview</button>
            <button data-idx="${idx}" class="btn rmBtn" style="background:#ef4444;padding:6px 8px;font-size:12px">Remove</button>
          </div>
        </div>`;
        filesListEl.appendChild(el);
      });
    }

    // Escape HTML helper
    function escapeHtml(s){ return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

    // read files from input
    async function readFiles(fileList) {
      for (const f of Array.from(fileList)) {
        // only read text files
        const text = await f.text();
        uploadedFiles.push({ name: f.name, type: f.type || guessLangFromName(f.name), size: text.length, content: text });
      }
      renderFilesList();
    }

    function guessLangFromName(name) {
      const ext = name.split('.').pop().toLowerCase();
      if (ext === 'py') return 'python';
      if (ext === 'js' || ext === 'mjs' || ext === 'cjs') return 'javascript';
      if (ext === 'ts') return 'typescript';
      if (ext === 'json') return 'json';
      if (ext === 'md') return 'markdown';
      return 'text';
    }

    // drag and drop
    dropZone.addEventListener('click', () => fileInput.click());
    dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.style.borderColor = '#7c3aed'; });
    dropZone.addEventListener('dragleave', () => { dropZone.style.borderColor = ''; });
    dropZone.addEventListener('drop', (e) => { e.preventDefault(); dropZone.style.borderColor = ''; if (e.dataTransfer.files) readFiles(e.dataTransfer.files); });

    fileInput.addEventListener('change', (e) => readFiles(e.target.files));
    clearFilesBtn.addEventListener('click', () => { uploadedFiles = []; renderFilesList(); });

    // delegate preview/remove buttons
    filesListEl.addEventListener('click', (e) => {
      const btn = e.target.closest('button');
      if (!btn) return;
      const idx = Number(btn.getAttribute('data-idx'));
      if (btn.classList.contains('previewBtn')) {
        const f = uploadedFiles[idx];
        const codeHtml = `<div class="small">Previewing <strong>${escapeHtml(f.name)}</strong> (language: ${escapeHtml(f.type)})</div>
          <pre class="code"><code>${escapeHtml(f.content.slice(0, 20000))}${f.content.length>20000 ? '\n\n...truncated...' : ''}</code></pre>`;
        addMessage(codeHtml, 'assistant', `file: ${f.name}`);
        // highlight
        setTimeout(() => { document.querySelectorAll('pre.code code').forEach((block) => hljs.highlightBlock(block)); }, 80);
      } else if (btn.classList.contains('rmBtn')) {
        uploadedFiles.splice(idx,1);
        renderFilesList();
      }
    });

    // Send handler
    sendBtn.addEventListener('click', () => sendPrompt());
    input.addEventListener('keydown', (e) => { if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)) { sendPrompt(); } });

    // main send function
    async function sendPrompt() {
      const userText = input.value.trim();
      if (!userText && uploadedFiles.length === 0) {
        alert('Please write a prompt or attach files.');
        return;
      }

      // show user message
      const filesSummary = uploadedFiles.map(f => f.name).join(', ');
      addMessage(`<div>${escapeHtml(userText || '(no prompt — sending files)')}</div><div class="small">Attached: ${escapeHtml(filesSummary || 'none')}</div>`, 'user', 'You');

      // Build the message string to send to Claude
      let composite = '';
      if (uploadedFiles.length) {
        for (const f of uploadedFiles) {
          composite += `-- filename: ${f.name} -- (language: ${f.type})\n`;
          composite += f.content + '\n\n';
        }
        composite += `-- end files --\n\n`;
      }
      composite += `User prompt: ${userText}\n\nInstructions: Please analyze the above files and respond. If they are code files, give clear, actionable suggestions, point out bugs, offer improvements, and provide example edits. When giving code snippets, include only the changed parts in a patch-like style.`;

      // Send to Puter.js (client side)
      // Use model: 'claude-sonnet-4-5' and stream: true for live streaming
      addMessage(`Waiting for assistant (streaming)...`, 'assistant', 'Assistant');

      try {
        const stream = await puter.ai.chat(composite, { model: 'claude-sonnet-4-5', stream: true });

        // remove the "waiting" placeholder and replace with streaming content
        // We'll append to the last assistant message
        let assistantNode = null;
        function createAssistantNode() {
          assistantNode = document.createElement('div');
          assistantNode.className = 'msg assistant';
          const meta = document.createElement('div'); meta.className = 'meta'; meta.textContent = 'Assistant (streaming)';
          const content = document.createElement('div'); content.className = 'streamingContent'; assistantNode.appendChild(meta); assistantNode.appendChild(content);
          messagesEl.appendChild(assistantNode);
          messagesEl.scrollTop = messagesEl.scrollHeight;
        }

        // if the stream is an async iterator
        if (stream[Symbol.asyncIterator]) {
          createAssistantNode();
          const contentEl = assistantNode.querySelector('.streamingContent');
          for await (const chunk of stream) {
            // chunk may be object or string depending on Puter API; try to extract text
            const text = (typeof chunk === 'string') ? chunk : (chunk?.text ?? chunk?.message?.content?.[0]?.text ?? '');
            if (text) {
              // append text (escape HTML, keep simple newlines)
              contentEl.innerHTML = escapeHtml(contentEl.textContent + text).replace(/\n/g,'<br/>');
              messagesEl.scrollTop = messagesEl.scrollHeight;
            }
          }
        } else {
          // not streaming; plain promise
          const response = await stream;
          addMessage(`<div>${escapeHtml(response?.message?.content?.[0]?.text || String(response))}</div>`, 'assistant', 'Assistant');
        }
      } catch (err) {
        console.error(err);
        addMessage(`<div class="small">Error: ${escapeHtml(String(err))}</div>`, 'assistant', 'Assistant');
      } finally {
        input.value = '';
        // reset files? keep them (user may want to iterate). If you want to auto-clear: uploadedFiles = []; renderFilesList();
      }
    }

    // small note: Puter.js docs show the script and models like claude-sonnet-4-5. See Puter docs for more features (function-calling etc).
    // Reference: https://developer.puter.com/tutorials/free-unlimited-claude-35-sonnet-api/
  </script>
</body>
</html>
